<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="x-ua-compatible" content="IE=edge" />

    <title>Indikator</title>

    <!-- Tailwind -->
    <link href="assets/css/tailwind.css" rel="stylesheet" />

    <!-- Zusatz-CSS (Filter etc.) -->
    <link href="assets/css/indikatoren-filter.css" rel="stylesheet" />

    <!-- JS Libraries -->
    <script src="assets/js/modules/jquery/dist/jquery.min.js"></script>
    <script src="assets/js/url-min.js"></script>
    <script src="assets/js/modules/proj4/dist/proj4.js"></script>

    <!-- Highcharts -->
    <script src="assets/js/modules/highcharts/highcharts.js"></script>
    <script src="assets/js/modules/highcharts/highcharts-more.js"></script>
    <script src="assets/js/modules/highcharts/modules/stock.js"></script>
    <script src="assets/js/modules/highcharts/modules/data.js"></script>
    <script src="assets/js/modules/highcharts/modules/map.js"></script>
    <script src="assets/js/modules/highcharts/modules/exporting.js"></script>

    <!-- Indikatoren-System -->
    <script src="charts/templates/options001.js"></script>
    <script src="metadata/all/kuerzelById.js"></script>
    <script src="metadata/all/idByKuerzel.js"></script>
    <script src="metadata/all/templatesById.js"></script>
    <script src="assets/js/indikatoren-highcharts.js"></script>
    <script src="assets/js/customFunctions.js"></script>

    <!-- GeoJSON -->
    <script src="geojson/wohnviertel_EPSG_2056.js"></script>
    <script src="geojson/wohnviertel_EPSG_2056_StadtBasel.js"></script>
    <script src="geojson/rhein_EPSG_2056.js"></script>
    <script src="geojson/UA_Gemeinden_100.js"></script>
    <script src="geojson/GemeindenBSBL_EPSG_2056.js"></script>

    <script
      src="https://cdn.jsdelivr.net/npm/@iframe-resizer/child"
      async
    ></script>

    <!-- Remove Highcharts default margins -->
    <style>
      .highcharts-container {
        margin: 0 !important;
      }
    </style>
  </head>

  <body class="bg-white m-0 p-0">
    <div id="chart" class="mx-auto w-full px-4 pt-6 pb-10 text-left"></div>

    <script>
      var kuerzel = decodeURIComponent($.url("?kuerzel"));
      var id = parseInt(decodeURIComponent($.url("?id")), 10);
      var suppressNumberInTitle =
        decodeURIComponent($.url("?suppressNumberInTitle")) === "true";

      if (idByKuerzel[kuerzel] || kuerzelById[id] || templatesById[id]) {
        if (id == "undefined") id = idByKuerzel[kuerzel];
        if (kuerzel == "undefined") kuerzel = kuerzelById[id];

        $.getJSON("metadata/single/" + id + ".json").done(function (
          chartMetadata
        ) {
          $("<div/>", { id: "container-" + id }).appendTo("#chart");

          var exportType = decodeURIComponent($.url("?thumbnailType"));
          var indikatorensetView =
            decodeURIComponent($.url("?indikatorensetView")) === "true";
          var view = decodeURIComponent($.url("?view"));
          if (!["indikatorenset", "portal", "print"].includes(view)) {
            view = indikatorensetView;
          }

          var hiddenSVG = decodeURIComponent($.url("?hiddenSVG")) === "true";

          lazyRenderChartById(
            id,
            chartMetadata,
            view,
            suppressNumberInTitle,
            function () {
              if (this.renderTo) {
                var thumbnailOffline =
                  decodeURIComponent($.url("?thumbnailOfflineExporting")) ===
                  "true";
                var exportServer = decodeURIComponent($.url("?exportServer"));
                var filename =
                  decodeURIComponent($.url("?kuerzelKundeAsFilename")) ===
                  "true"
                    ? chartMetadata.kuerzelKunde
                    : undefined;

                if (thumbnailOffline) {
                  $.getScript(
                    "assets/js/modules/highcharts/modules/offline-exporting.js",
                    function () {
                      createThumbnail(
                        id,
                        kuerzel,
                        exportType,
                        thumbnailOffline,
                        undefined,
                        filename
                      );
                    }
                  );
                } else {
                  createThumbnail(
                    id,
                    kuerzel,
                    exportType,
                    thumbnailOffline,
                    exportServer,
                    filename
                  );
                }

                if (hiddenSVG) {
                  setTimeout(function () {
                    window.svg = $("svg").clone().wrap("<svg>").parent().html();
                    $("body").append(
                      '<div id="chartSVG" class="hidden">' +
                        window.svg +
                        "</div>"
                    );
                    $("#chartSVG .highcharts-button").remove();
                    $("body").append('<div id="renderDone"/>');
                  }, 1000);
                }
              }
            }
          );
        });
      } else {
        $("body").append(`
          <div class="max-w-xl mx-auto mt-20 text-center">
            <h1 class="text-2xl font-bold mb-4">Ooops…</h1>
            <p class="text-gray-700">
              Kein Chart mit diesem Kürzel oder dieser ID gefunden.
            </p>
          </div>
        `);
      }

      function createThumbnail(
        id,
        kuerzel,
        exportType,
        offline,
        exportServer,
        filename
      ) {
        switch (exportType) {
          case "jpg":
            exportThumbnail(id, "image/jpeg", offline, exportServer, filename);
            break;
          case "png":
            exportThumbnail(id, "image/png", offline, exportServer, filename);
            break;
          case "svg":
            exportThumbnail(
              id,
              "image/svg+xml",
              offline,
              exportServer,
              filename
            );
            break;
          case "pdf":
            exportThumbnail(
              id,
              "application/pdf",
              offline,
              exportServer,
              filename
            );
            break;
        }
      }
    </script>
  </body>
</html>
